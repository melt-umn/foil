#!/usr/bin/env bash
set -euox pipefail

export GRAMMAR_PATH=grammars

mkdir -p generated
export SILVER_GEN=generated

# Need to bump up the heap space to run the MWDA:
export SVJVM_FLAGS="-Xmx6G -Xss25m"

SV_FLAGS="$@"

# Build host
silver -o foil.jar $SV_FLAGS edu:umn:cs:melt:foil:host
export GRAMMAR_PATH="foil.jar:$GRAMMAR_PATH"

# Build extended Silver compiler
silver -o silver_compiler.jar $SV_FLAGS edu:umn:cs:melt:foil:composed:silver_compiler

# Build extensions
build_extension() {
  silver-custom silver_compiler.jar -o foil-$1.jar $SV_FLAGS edu:umn:cs:melt:foil:extensions:$1
  export GRAMMAR_PATH="foil-$1.jar:$GRAMMAR_PATH"
}

build_extension complex
build_extension closure
build_extension datatype
build_extension intconst

# Build compiler
#silver -o compiler.jar $SV_FLAGS edu:umn:cs:melt:foil:composed:host
silver -o compiler.jar $SV_FLAGS edu:umn:cs:melt:foil:composed:with_all

# Perform MDA tests
silver --dont-translate $SV_FLAGS edu:umn:cs:melt:foil:composed:mda_tests
